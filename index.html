<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
  const SUPABASE_URL = "https://cxqjjhmzeynerihybjsd.supabase.co";
  const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImN4cWpqaG16ZXluZXJpaHlianNkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjM0NTcyMTgsImV4cCI6MjA3OTAzMzIxOH0.xiMMHudBafGBlRwFfKvcS_fsssNojSgHFSrFBfaSUFE";
  const db = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
</script>



<!-- ============================================================ -->
<!-- === VERSION A: DISE√ëO EXACTO (CSS REESCRITO EN INLINE) ====== -->
<!-- ============================================================ -->

<div style="font-family: system-ui, Arial, sans-serif; padding: 12px;">
    <h2 style="margin-bottom: 8px;">Reservas de Tutor√≠as ‚Äì F√≠sica </h2>
    <div style="font-size: 13px; color: #555; margin-bottom: 12px;">
        Horarios: lunes a viernes, 08:00‚Äì17:00 (intervalos 30 min). Almuerzo 13:00‚Äì14:00. Cupo m√°ximo: 3 estudiantes por franja.
    </div>

    <!-- FORMULARIO -->
    <div style="background: #fff; padding: 12px; border-radius: 8px; box-shadow: 0 4px 14px rgba(0,0,0,0.06); margin-bottom: 20px;">
        <h3 style="margin-top: 0;">Reservar tutor√≠a</h3>

        <form id="formA">
            <label style="font-size: 13px;">Nombre completo
        <input id="nameA" type="text" required="" style="width:100%; padding:8px; margin-top:6px; border:1px solid #ddd; border-radius:6px;">
      </label><br><br>

            <label style="font-size: 13px;">Email institucional (EPN)
        <input id="emailA" type="email" required="" style="width:100%; padding:8px; margin-top:6px; border:1px solid #ddd; border-radius:6px;">
      </label><br><br>

            <label style="font-size: 13px;">C√≥digo
        <input id="codigoA" type="text" required="" style="width:100%; padding:8px; margin-top:6px; border:1px solid #ddd; border-radius:6px;">
      </label><br><br>

            <label style="font-size: 13px;">D√≠a
        <select id="dayA" style="width:100%; padding:8px; margin-top:6px; border:1px solid #ddd; border-radius:6px;"></select>
      </label><br><br>

            <label style="font-size: 13px;">Hora
        <select id="timeA" style="width:100%; padding:8px; margin-top:6px; border:1px solid #ddd; border-radius:6px;"></select>
      </label><br><br>

            <button type="submit" style="background:#0b5ed7; color:white; border:none; padding:10px; border-radius:8px; width:100%; cursor:pointer;">Reservar</button>

            <div id="msgA" style="margin-top:10px; font-size:13px;"></div>
        </form>
    </div>

    <!-- CALENDARIO -->
    <h3>Calendario semanal</h3>
    <div id="calendarA" style="overflow-x:auto;"></div>

    <!-- üî• BOT√ìN DE ADMIN PARA RESETEAR TODO -->
    <div style="margin-top:20px; text-align:center;">
        <button onclick="resetReservasA()" style="background:#b30000; color:white; padding:10px 18px; border:none; border-radius:8px; cursor:pointer;">
      Resetear TODAS las Reservas (Admin)
    </button>
    </div>

</div>

<script>
    /* ------------------------------ CONFIG ------------------------------ */
    const DAYS = ["Lunes", "Martes", "Mi√©rcoles", "Jueves", "Viernes"];
    const STORAGE_A = "reservas_tutorias_exacta";

    function genTimes() {
        let out = [];
        for (let h = 8; h < 17; h++) {
            for (let m = 0; m < 60; m += 30) {
                let t = `${String(h).padStart(2,"0")}:${m === 0 ? "00" : "30"}`;
                if (!(t >= "13:00" && t < "14:00")) out.push(t);
            }
        }
        return out;
    }
    const TIMES = genTimes();

    async function loadA() {
        let { data, error } = await db
            .from("reservas")
            .select("*");

        if (error) {
            console.error(error);
            return {};
        }

        // convertir la tabla en formato { "Lunes|08:00": [lista] }
        let grouped = {};

        data.forEach(r => {
            const key = `${r.day}|${r.time}`;
            if (!grouped[key]) grouped[key] = [];
            grouped[key].push(r);
        });

        return grouped;
    }

    function saveA(obj) {
        localStorage.setItem(STORAGE_A, JSON.stringify(obj));
    }

    /* ------------------------------ RENDER CALENDARIO ------------------------------ */
    function renderCalendarA() {
        const data = loadA();
        let html = '<table style="border-collapse:collapse; width:100%; min-width:720px;">';
        html += '<tr><th style="border:1px solid #eee; padding:6px; background:#fafafa;">Hora</th>';
        DAYS.forEach(d => {
            html += `<th style='border:1px solid #eee; padding:6px; background:#fafafa;'>${d}</th>`;
        });
        html += '</tr>';

        TIMES.forEach(t => {
            html += `<tr><th style='border:1px solid #eee; padding:6px;'>${t}</th>`;

            DAYS.forEach(day => {
                const key = day + "|" + t;
                const list = data[key] || [];
                const full = list.length >= 3;
                const bg = full ? "#f7c5c5" : "#c8f7c5";

                html += `<td data-k='${key}' style='border:1px solid #eee; padding:6px; background:${bg}; cursor:pointer;'>`;
                html += `<div><b>${list.length}/3</b></div>`;
                if (list.length === 0) html += `<div style='font-size:12px;'>Disponible</div>`;
                else html += `<div style='font-size:12px;'>${list.map(r => r.name + " (" + r.codigo + ")").join('<br>')}</div>`;
                html += '</td>';
            });

            html += '</tr>';
        });

        html += '</table>';
        document.getElementById("calendarA").innerHTML = html;

        /* Click en celdas para autocompletar */
        document.querySelectorAll('#calendarA td').forEach(td => {
            td.onclick = () => {
                const [d, h] = td.getAttribute('data-k').split('|');
                document.getElementById('dayA').value = d;
                document.getElementById('timeA').value = h;
                window.scrollTo({
                    top: 0,
                    behavior: 'smooth'
                });
            };
        });
    }

    /* ------------------------------ FORMULARIO A ------------------------------ */
    function initFormA() {
        const dSel = document.getElementById('dayA');
        const tSel = document.getElementById('timeA');
        dSel.innerHTML = DAYS.map(d => `<option>${d}</option>`).join('');
        tSel.innerHTML = TIMES.map(t => `<option>${t}</option>`).join('');

        document.getElementById('formA').onsubmit = e => {
            e.preventDefault();
            let name = document.getElementById('nameA').value.trim();
            let email = document.getElementById('emailA').value.trim();
            let codigo = document.getElementById('codigoA').value.trim();
            let day = dSel.value;
            let time = tSel.value;
            let msg = document.getElementById('msgA');

            if (!/^[^@\s]+@epn\.edu\.ec$/i.test(email)) {
                msg.style.color = 'red';
                msg.innerHTML = "Debe usar correo @epn.edu.ec";
                return;
            }

            const key = day + '|' + time;
            const data = loadA();
            const list = data[key] || [];

            if (list.some(r => r.email.toLowerCase() === email.toLowerCase())) {
                msg.style.color = 'red';
                msg.innerHTML = "Ya tiene reserva en ese horario.";
                return;
            }
            if (list.length >= 3) {
                msg.style.color = 'red';
                msg.innerHTML = "Horario sin cupo.";
                return;
            }

            // Guardar en Supabase
            let { error } = await db
              .from("reservas")
              .insert({
                name: name,
                email: email,
                codigo: codigo,
                day: day,
                time: time
            });

            if (error) {
                msg.style.color = 'red';
                msg.innerHTML = "Error al guardar la reserva.";
                console.error(error);
                return;
            }
            msg.style.color = 'green';
            msg.innerHTML = "Reserva confirmada correctamente üëç";
            data[key] = list;
            saveA(data);
            msg.style.color = 'green';
            msg.innerHTML = "Reserva confirmada.";
            renderCalendarA();
        };
    }

    initFormA();
    renderCalendarA();

    /* ------------------------------ RESET SOLO ADMIN ------------------------------ */
    function resetReservasA() {
        const clave = prompt("Ingrese la contrase√±a de administrador:");

        if (clave === "CALEB2024reset") {
            localStorage.removeItem(STORAGE_A);
            alert("‚úî Reservas borradas.");
            renderCalendarA();
        } else if (clave !== null) {
            alert("‚ùå Contrase√±a incorrecta.");
        }
    }
</script>
