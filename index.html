<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Reservas Tutorías - Supabase</title>
</head>
<body style="font-family: system-ui, Arial, sans-serif; padding:12px;">

  <h2>Reservas de Tutorías – Física (Supabase)</h2>
  <p style="color:#555">
    Ahora puedes seleccionar la semana (2025–2026).  
    Horarios: lunes a viernes, 08:00–17:00 (30 min). Almuerzo 13:00–14:00. Máximo 3 estudiantes por franja.
  </p>

  <!-- NUEVO: selector de semana -->
  <div style="margin-bottom:15px;">
    <label><b>Semana:</b></label>
    <select id="weekA" style="padding:6px;border:1px solid #ccc;border-radius:6px;"></select>
  </div>

  <div style="background:#fff;padding:12px;border-radius:8px;box-shadow:0 4px 14px rgba(0,0,0,0.06); margin-bottom:20px;">
    <h3 style="margin-top:0">Reservar tutoría</h3>

    <form id="formA">
      <label>Nombre completo
        <input id="nameA" type="text" required style="width:100%;padding:8px;margin-top:6px;border:1px solid #ddd;border-radius:6px;">
      </label><br><br>

      <label>Email institucional (EPN)
        <input id="emailA" type="email" required style="width:100%;padding:8px;margin-top:6px;border:1px solid #ddd;border-radius:6px;">
      </label><br><br>

      <label>Código
        <input id="codigoA" type="text" required style="width:100%;padding:8px;margin-top:6px;border:1px solid #ddd;border-radius:6px;">
      </label><br><br>

      <label>Día
        <select id="dayA" style="width:100%;padding:8px;margin-top:6px;border:1px solid #ddd;border-radius:6px;"></select>
      </label><br><br>

      <label>Hora
        <select id="timeA" style="width:100%;padding:8px;margin-top:6px;border:1px solid #ddd;border-radius:6px;"></select>
      </label><br><br>

      <button type="submit" style="background:#0b5ed7;color:white;border:none;padding:10px;border-radius:8px;width:100%;cursor:pointer;">Reservar</button>

      <div id="msgA" style="margin-top:10px;font-size:13px;"></div>
    </form>
  </div>

  <h3>Calendario semanal</h3>
  <div id="calendarA" style="overflow-x:auto;"></div>

  <!-- Supabase JS -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <script>
    // -------- CONFIG SUPABASE ----------
    const SUPABASE_URL = "https://cxqjjhmzeynerihybjsd.supabase.co";
    const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImN4cWpqaG16ZXluZXJpaHlianNkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjM0NTcyMTgsImV4cCI6MjA3OTAzMzIxOH0.xiMMHudBafGBlRwFfKvcS_fsssNojSgHFSrFBfaSUFE";
    const db = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    const DAYS = ["Lunes", "Martes", "Miércoles", "Jueves", "Viernes"];
    const TIMES = (function genTimes(){
      let out = [];
      for (let h=8; h<17; h++){
        for (let m=0; m<60; m+=30){
          let t = `${String(h).padStart(2,"0")}:${m===0?"00":"30"}`;
          if (!(t >= "13:00" && t < "14:00")) out.push(t);
        }
      }
      return out;
    })();

    function q(id){ return document.getElementById(id); }

    // --- NUEVO: generar semanas 2025–2026 ---
    function generateWeeks(){
      let out = [];
      const start = new Date("2025-01-01");
      const end = new Date("2026-12-31");

      let current = new Date(start);
      while (current <= end){
        if (current.getDay() === 1){ // lunes
          const y = current.getFullYear();
          const m = String(current.getMonth()+1).padStart(2,"0");
          const d = String(current.getDate()).padStart(2,"0");
          out.push(`${y}-${m}-${d}`); // week_id
        }
        current.setDate(current.getDate()+1);
      }
      return out;
    }

    const WEEKS = generateWeeks();


    // -------- Cargar reservas (AÑADIDO week_id) ----------
    async function loadA(){
      const week = q("weekA").value;

      const { data, error } = await db
        .from('reservas')
        .select('*')
        .eq('week_id', week)
        .order('created_at', {ascending:true});

      if (error) { console.error(error); return {}; }

      let grouped = {};
      data.forEach(r => {
        const key = `${r.day}|${r.time}`;
        if (!grouped[key]) grouped[key] = [];
        grouped[key].push({ name: r.name, email: r.email, codigo: r.codigo});
      });
      return grouped;
    }

    // -------- Guardar reserva vía RPC (AÑADIDO week_id) ----------
    async function saveReserveRPC({name, email, codigo, day, time, week_id}){
      const { data, error } = await db.rpc('reserve_slot', {
        p_name: name,
        p_email: email,
        p_codigo: codigo,
        p_day: day,
        p_time: time,
        p_week_id: week_id
      });
      return { data, error };
    }

    // -------- Renderizado del calendario ----------
    async function renderCalendarA(){
      const data = await loadA();
      let html = '<table style="border-collapse:collapse; width:100%; min-width:720px;">';
      html += '<tr><th style="border:1px solid #eee; padding:6px; background:#fafafa;">Hora</th>';
      DAYS.forEach(d => html += `<th style='border:1px solid #eee; padding:6px; background:#fafafa;'>${d}</th>`);
      html += '</tr>';

      TIMES.forEach(t => {
        html += `<tr><th style='border:1px solid #eee; padding:6px;'>${t}</th>`;
        DAYS.forEach(day => {
          const key = day + "|" + t;
          const list = data[key] || [];
          const full = list.length >= 3;
          const bg = full ? "#f7c5c5" : "#c8f7c5";

          html += `<td data-k='${key}' style='border:1px solid #eee; padding:6px; background:${bg}; cursor:pointer;'>`;
          html += `<div><b>${list.length}/3</b></div>`;
          if (list.length === 0) html += `<div style='font-size:12px;'>Disponible</div>`;
          else html += `<div style='font-size:12px;'>${list.map(r => r.name + " ("+r.codigo+")").join('<br>')}</div>`;
          html += '</td>';
        });
        html += '</tr>';
      });

      html += '</table>';
      q('calendarA').innerHTML = html;

      document.querySelectorAll('#calendarA td').forEach(td => {
        td.onclick = () => {
          const [d,h] = td.getAttribute('data-k').split('|');
          q('dayA').value = d;
          q('timeA').value = h;
          window.scrollTo({top:0, behavior:'smooth'});
        };
      });
    }

    // -------- Inicialización del formulario ----------
    function initFormA(){

      // llenar semanas
      q("weekA").innerHTML = WEEKS.map(w => `<option>${w}</option>`).join('');

      q('dayA').innerHTML = DAYS.map(d => `<option>${d}</option>`).join('');
      q('timeA').innerHTML = TIMES.map(t => `<option>${t}</option>`).join('');

      q("weekA").onchange = renderCalendarA;

      q('formA').onsubmit = async (e) => {
        e.preventDefault();
        
        const name = q('nameA').value.trim();
        const email = q('emailA').value.trim();
        const codigo = q('codigoA').value.trim();
        const day = q('dayA').value;
        const time = q('timeA').value;
        const week = q('weekA').value;

        const msg = q('msgA');

        if (!/^[^@\s]+@epn\.edu\.ec$/i.test(email)) {
          msg.style.color='red'; 
          msg.innerHTML='Debe usar correo @epn.edu.ec'; 
          return;
        }

        msg.style.color='black';
        msg.innerHTML='Guardando reserva...';

        const res = await saveReserveRPC({name,email,codigo,day,time,week_id:week});
        if (res.error) {
          console.error(res.error);
          msg.style.color='red';
          msg.innerHTML = "Error al guardar la reserva.";
          return;
        }

        const result = Array.isArray(res.data) ? res.data[0] : res.data;

        if (result === 'FULL') {
          msg.style.color='red';
          msg.innerHTML = "Horario sin cupo (ya hay 3 reservas).";
        } else if (result === 'DUP') {
          msg.style.color='red';
          msg.innerHTML = "Ya tienes una reserva en esa franja.";
        } else {
          msg.style.color='green';
          msg.innerHTML = "Reserva confirmada.";
        }

        setTimeout(renderCalendarA, 400);
      };
    }

    // -------- Iniciar aplicación ----------
    initFormA();
    renderCalendarA();

  </script>
</body>
</html>
