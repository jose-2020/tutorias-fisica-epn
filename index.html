<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Reservas Tutorías</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<script src="https://unpkg.com/@supabase/supabase-js@2"></script>

<style>
body {
  font-family: Arial, sans-serif;
  margin: 0;
  padding: 20px;
  background: #f4f4f4;
}
h1,h2 {
  text-align: center;
}
.container {
  max-width: 900px;
  margin: auto;
  background: white;
  padding: 20px;
  border-radius: 10px;
}
input, select, button {
  width: 100%;
  padding: 10px;
  margin-top: 8px;
  border: 1px solid #ccc;
  border-radius: 6px;
  font-size: 15px;
}
button {
  background: #0077cc;
  color: white;
  border: none;
  cursor: pointer;
  margin-top: 12px;
}
button:hover {
  background: #005fa3;
}
.table {
  display: grid;
  grid-template-columns: repeat(6,1fr);
  gap: 10px;
  margin-top: 20px;
}
.cell {
  background: #f0f0f0;
  padding: 10px;
  min-height: 80px;
  border-radius: 6px;
}
.slot-title {
  font-weight: bold;
  margin-bottom: 8px;
}
.reserva {
  background: white;
  border-left: 4px solid #0077cc;
  padding: 5px;
  margin-top: 5px;
  border-radius: 4px;
  font-size: 13px;
}
</style>
</head>

<body>

<div class="container">
<h1>Sistema de Reservas – Tutorías</h1>

<h2>Hacer una Reserva</h2>

<label>Nombre
  <input id="nameA" type="text" required>
</label>

<label>Email institucional
  <input id="emailA" type="email" required>
</label>

<label>Código (3 números)
  <input id="codigoA" type="text" maxlength="3">
</label>

<label>Día
  <select id="dayA">
    <option>Lunes</option>
    <option>Martes</option>
    <option>Miércoles</option>
    <option>Jueves</option>
    <option>Viernes</option>
  </select>
</label>

<label>Fecha
  <input id="fechaA" type="date" required>
</label>

<label>Hora
  <select id="timeA">
    <option>10:00</option>
    <option>10:30</option>
    <option>11:00</option>
    <option>11:30</option>
    <option>12:00</option>
  </select>
</label>

<button id="btnReserva">Reservar</button>

<h2>Calendario semanal</h2>
<div id="calA" class="table"></div>

</div>

<script>
// ==========================
// CONFIGURAR SUPABASE
// ==========================
const db = supabase.createClient(
  "TU_URL_SUPABASE",
  "TU_ANON_KEY"
);

// ==========================
// Selección rápida
// ==========================
const q = id => document.getElementById(id);

// ==========================
// Calcular lunes-viernes de la semana
// ==========================
function getWeekRange(dateStr){
  const d = new Date(dateStr);
  const day = d.getDay() === 0 ? 7 : d.getDay(); // lunes=1
  const monday = new Date(d);
  monday.setDate(d.getDate() - (day - 1));

  const friday = new Date(monday);
  friday.setDate(monday.getDate() + 4);

  return {
    start: monday.toISOString().slice(0,10),
    end: friday.toISOString().slice(0,10)
  };
}

// ==========================
// Cargar reservas de la semana
// ==========================
async function loadA(fechaBase){
  if (!fechaBase) return {};

  const { start, end } = getWeekRange(fechaBase);

  const { data, error } = await db
    .from("reservas")
    .select("*")
    .gte("fecha", start)
    .lte("fecha", end)
    .order("created_at", {ascending:true});

  if (error || !data) return {};

  let grouped = {};

  data.forEach(r => {
    const key = `${r.day}|${r.time}`;
    if (!grouped[key]) grouped[key] = [];
    grouped[key].push({
      name: r.name,
      email: r.email,
      codigo: r.codigo,
      fecha: r.fecha
    });
  });

  return grouped;
}

// ==========================
// Guardar reserva por RPC
// ==========================
async function saveReserveRPC({name, email, codigo, day, fecha, time}){

  const { data, error } = await db.rpc("reserve_slot", {
    p_name: name,
    p_email: email,
    p_codigo: codigo,
    p_day: day,
    p_fecha: fecha,
    p_time: time
  });

  if (error) return null;
  return data;
}

// ==========================
// Render del calendario
// ==========================
async function renderCalendarA(){
  const fechaBase = q("fechaA").value || new Date().toISOString().slice(0,10);

  const data = await loadA(fechaBase);

  const dias = ["Lunes","Martes","Miércoles","Jueves","Viernes"];
  const horas = ["10:00","10:30","11:00","11:30","12:00"];

  let html = "";

  dias.forEach(d => {
    horas.forEach(h => {
      const key = `${d}|${h}`;
      html += `<div class="cell">
        <div class="slot-title">${d} ${h}</div>
      `;

      if (data[key]) {
        data[key].forEach(r => {
          html += `<div class="reserva">
            ${r.name} – ${r.email}<br>
            Código: ${r.codigo}<br>
            Fecha: ${r.fecha}
          </div>`;
        });
      }

      html += `</div>`;
    });
  });

  q("calA").innerHTML = html;
}

// ==========================
// Hacer reserva
// ==========================
q("btnReserva").onclick = async () => {
  const name = q("nameA").value.trim();
  const email = q("emailA").value.trim();
  const codigo = q("codigoA").value.trim();
  const day = q("dayA").value;
  const fecha = q("fechaA").value;
  const time = q("timeA").value;

  if (!name || !email || !codigo || !fecha){
    alert("Todos los campos son obligatorios.");
    return;
  }

  const res = await saveReserveRPC({name, email, codigo, day, fecha, time});

  if (res === "OK"){
    alert("Reserva realizada con éxito.");
    await renderCalendarA();
  }
  else if (res === "FULL"){
    alert("Ese horario ya está lleno (máx: 3).");
  }
  else if (res === "DUP"){
    alert("Ya tienes una reserva en ese horario.");
  }
  else{
    alert("Hubo un error inesperado.");
  }
};

// Actualizar calendario al cambiar fecha
q("fechaA").onchange = renderCalendarA;

// Render inicial
q("fechaA").value = new Date().toISOString().slice(0,10);
renderCalendarA();

</script>
</body>
</html>
