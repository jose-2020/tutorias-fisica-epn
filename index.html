<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Reservas Tutorías </title>
</head>
<body style="font-family: system-ui, Arial, sans-serif; padding:12px;">

  <h2>Reservas de Tutorías – Física y Mecánica Newtoniana</h2>
  <p style="color:#555">Horarios: lunes a viernes, 08:00–17:00 (intervalos 30 min). Almuerzo 13:00–14:00. Cupo máximo: 3 estudiantes por franja.</p>

  <div style="background:#fff;padding:12px;border-radius:8px;box-shadow:0 4px 14px rgba(0,0,0,0.06); margin-bottom:20px;">
    <h3 style="margin-top:0">Reservar tutoría</h3>

    <form id="formA">
      <label>Nombre completo
        <input id="nameA" type="text" required style="width:100%;padding:8px;margin-top:6px;border:1px solid #ddd;border-radius:6px;">
      </label><br><br>

      <label>Email institucional (EPN)
        <input id="emailA" type="email" required style="width:100%;padding:8px;margin-top:6px;border:1px solid #ddd;border-radius:6px;">
      </label><br><br>

      <label>Código
        <input id="codigoA" type="text" required style="width:100%;padding:8px;margin-top:6px;border:1px solid #ddd;border-radius:6px;">
      </label><br><br>

      <label>Grupo (Paralelo)
        <input id="grupoA" type="text" required style="width:100%;padding:8px;margin-top:6px;border:1px solid #ddd;border-radius:6px;">
      </label><br><br>
      
            
      <label>Día
        <select id="dayA" style="width:100%;padding:8px;margin-top:6px;border:1px solid #ddd;border-radius:6px;"></select>
      </label><br><br>

      <label>Hora
        <select id="timeA" style="width:100%;padding:8px;margin-top:6px;border:1px solid #ddd;border-radius:6px;"></select>
      </label><br><br>

      <button type="submit" style="background:#0b5ed7;color:white;border:none;padding:10px;border-radius:8px;width:100%;cursor:pointer;">Reservar</button>

      <div id="msgA" style="margin-top:10px;font-size:13px;"></div>
    </form>
  </div>

  <!-- CONTROLES DE SEMANA -->
  <div style="display:flex; justify-content:space-between; margin:12px 0;">
    <button id="prevWeek" style="padding:6px 12px;">⬅ Semana anterior</button>
    <h3 id="weekLabel"></h3>
    <button id="nextWeek" style="padding:6px 12px;">Semana siguiente ➡</button>
  </div>

  <h3>Calendario semanal</h3>
  <div id="calendarA" style="overflow-x:auto;"></div>

  <!-- Supabase JS -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <script>
    // -------- CONFIG SUPABASE ----------
    const SUPABASE_URL = "https://cxqjjhmzeynerihybjsd.supabase.co";
    const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImN4cWpqaG16ZXluZXJpaHlianNkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjM0NTcyMTgsImV4cCI6MjA3OTAzMzIxOH0.xiMMHudBafGBlRwFfKvcS_fsssNojSgHFSrFBfaSUFE";
    const db = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    const DAYS = ["Lunes", "Martes", "Miércoles", "Jueves", "Viernes"];
    const TIMES = (function genTimes(){
      let out = [];
      for (let h=8; h<17; h++){
        for (let m=0; m<60; m+=30){
          let t = `${String(h).padStart(2,"0")}:${m===0?"00":"30"}`;
          if (!(t >= "13:00" && t < "14:00")) out.push(t);
        }
      }
      return out;
    })();

    function q(id){ return document.getElementById(id); }

    // --------- FUNCIONES DE SEMANA ----------
    let currentMonday = getMonday(new Date());

    function getMonday(d){
      d = new Date(d);
      const day = d.getDay();
      const diff = d.getDate() - (day === 0 ? 6 : day - 1);
      return new Date(d.setDate(diff));
    }

    function addDays(date, days){
      const d = new Date(date);
      d.setDate(d.getDate() + days);
      return d;
    }

    function formatDate(d){
      return d.toLocaleDateString("es-ES", { day:"2-digit", month:"short" });
    }

    // --------- BOTONES SEMANA ----------
    document.getElementById("prevWeek").onclick = () => {
      const today = getMonday(new Date());
      const prev = addDays(currentMonday, -7);
      //if (prev < today) return; // bloquear semanas pasadas
      currentMonday = prev;
      renderCalendarA();
    };

    document.getElementById("nextWeek").onclick = () => {
      currentMonday = addDays(currentMonday, +7);
      renderCalendarA();
    };

    // -------- Cargar reservas ----------
    async function loadA(){
      const { data, error } = await db
        .from('reservas')
        .select('*')
        .eq('week_id', currentMonday.toISOString().slice(0,10))
        .order('created_at', {ascending:true});

      if (error) { console.error(error); return {}; }

      let grouped = {};
      data.forEach(r => {
        const key = `${r.day}|${r.time}`;
        if (!grouped[key]) grouped[key] = [];
        grouped[key].push({
          name: r.name,
          email: r.email,
          codigo: r.codigo
        });
      });
      return grouped;
    }

    // -------- Guardar reserva vía RPC ----------
    async function saveReserveRPC({name, email, codigo, grupo, day, time, week_id}){
      const { data, error } = await db.rpc('reserve_slot', {
        p_name: name,
        p_email: email,
        p_codigo: codigo,
        p_grupo: grupo,
        p_day: day,
        p_time: time,
        p_week_id: week_id
      });
      return { data, error };
    }

    // ------------------- CALENDARIO SEMANAL ------------------------
    async function renderCalendarA(){
      const data = await loadA();

      // etiqueta semana
      const endWeek = addDays(currentMonday, 4);
      document.getElementById("weekLabel").innerHTML =
        `Semana del ${formatDate(currentMonday)} al ${formatDate(endWeek)}`;

      let html = '<table style="border-collapse:collapse; width:100%; min-width:720px;">';

      // Encabezados con fechas
      html += "<tr><th style='border:1px solid #eee; padding:6px; background:#fafafa;'>Hora</th>";
      for (let i=0; i<5; i++){
        const d = addDays(currentMonday, i);
        html += `<th style='border:1px solid #eee; padding:6px; background:#fafafa;'>
                   ${DAYS[i]}<br>${formatDate(d)}
                 </th>`;
      }
      html += "</tr>";

      // Celdas
      TIMES.forEach(t => {
        html += `<tr><th style='border:1px solid #eee; padding:6px;'>${t}</th>`;

        for (let i=0; i<5; i++){
          const date = addDays(currentMonday, i);
          const dayName = DAYS[i];
          const key = `${dayName}|${t}`;
          const list = data[key] || [];
          const full = list.length >= 3;
          const bg = full ? "#f7c5c5" : "#c8f7c5";

          //const isPast = date < getMonday(new Date());
          const now = new Date();
          const isToday = date.toDateString() === now.toDateString();

          let isPast = false;

          // Bloquear días anteriores a hoy
          if (date < new Date(now.getFullYear(), now.getMonth(), now.getDate())) {
            isPast = true;
          }
          // Si es hoy, bloquear horas pasadas
          else if (isToday && t <= now.toTimeString().slice(0, 5)) {
            isPast = true;
          }


          html += `<td data-k='${key}'
                     style='border:1px solid #eee; padding:6px;
                            background:${bg};
                            cursor:${isPast ? "not-allowed" : "pointer"};
                            opacity:${isPast ? "0.40" : "1"};'>`;

          html += `<div><b>${list.length}/3</b></div>`;

          if (list.length === 0)
            html += `<div style='font-size:12px;'>Disponible</div>`;
          else
            html += `<div style='font-size:12px;'>${list.map(r => r.name + " ("+r.codigo+")").join('<br>')}</div>`;

          html += `</td>`;
        }

        html += "</tr>";
      });

      html += "</table>";
      q("calendarA").innerHTML = html;

      // click en celdas (solo semanas válidas)
      document.querySelectorAll('#calendarA td').forEach(td => {
        if (td.style.cursor === "not-allowed") return;
        td.onclick = () => {
          const [d,h] = td.getAttribute('data-k').split('|');
          q('dayA').value = d;
          q('timeA').value = h;
          window.scrollTo({top:0, behavior:'smooth'});
        };
      });
    }

    // -------- Inicialización del formulario ----------
    function initFormA(){
      q('dayA').innerHTML = DAYS.map(d => `<option>${d}</option>`).join('');
      q('timeA').innerHTML = TIMES.map(t => `<option>${t}</option>`).join('');

      q('formA').onsubmit = async (e) => {
        e.preventDefault();

        const name = q('nameA').value.trim();
        const email = q('emailA').value.trim();
        const codigo = q('codigoA').value.trim();
        const grupo = q('grupoA').value.trim();
        const day = q('dayA').value;
        const time = q('timeA').value;
        const msg = q('msgA');

        if (!/^[^@\s]+@epn\.edu\.ec$/i.test(email)) {
          msg.style.color='red';
          msg.innerHTML='Debe usar correo @epn.edu.ec';
          return;
        }

        msg.style.color='black';
        msg.innerHTML='Guardando reserva...';

        const res = await saveReserveRPC({name,email,codigo,grupo,day,time,week_id: currentMonday.toISOString().slice(0,10)});
        if (res.error) {
          console.error(res.error);
          msg.style.color='red';
          msg.innerHTML = "Error al guardar la reserva.";
          return;
        }

        const result = Array.isArray(res.data) ? res.data[0] : res.data;

        if (result === 'FULL') {
          msg.style.color='red';
          msg.innerHTML = "Horario sin cupo (ya hay 3 reservas).";
        } 
        else if (result === 'DUP') {
          msg.style.color='red';
          msg.innerHTML = "Ya tienes una reserva en esa franja.";
        } 
        else {
          msg.style.color='green';
          msg.innerHTML = "Reserva confirmada.";
        }

        setTimeout(renderCalendarA, 400);
      };
    }

    // -------- Iniciar aplicación ----------
    initFormA();
    renderCalendarA();

  </script>
</body>
</html>
